# GitHub Grader - Modular Architecture

This document outlines the refactored modular structure of the GitHub Grader Google Apps Script system.

## üìÅ File Structure

```
src/
‚îú‚îÄ‚îÄ config.ts              # Configuration constants
‚îú‚îÄ‚îÄ types.ts               # TypeScript interface definitions  
‚îú‚îÄ‚îÄ github-api.ts          # GitHub API service layer
‚îú‚îÄ‚îÄ sheets-service.ts      # Google Sheets operations
‚îú‚îÄ‚îÄ grading-service.ts     # OpenAI integration & grading logic
‚îú‚îÄ‚îÄ utils.ts               # Utility functions and helpers
‚îú‚îÄ‚îÄ main-refactored.ts     # Main orchestration & UI (NEW VERSION)
‚îî‚îÄ‚îÄ main.ts                # Original monolithic version (LEGACY)
```

## üèóÔ∏è Architecture Overview

### 1. **config.ts** - Central Configuration
- **Purpose**: All configuration constants in one place
- **Contains**: Sheet names, column mappings, API endpoints, cache settings
- **Benefits**: Easy to modify settings, environment-specific configs

### 2. **types.ts** - Type Definitions  
- **Purpose**: TypeScript interfaces and type safety
- **Contains**: Data structures, API response types, function signatures
- **Benefits**: Better IntelliSense, compile-time error checking, documentation

### 3. **github-api.ts** - GitHub Integration
- **Purpose**: All GitHub API interactions with caching
- **Contains**: PR fetching, file retrieval, review creation, grading instructions
- **Benefits**: Rate limiting protection, request caching, API error handling

### 4. **sheets-service.ts** - Google Sheets Operations
- **Purpose**: Optimized spreadsheet operations with caching
- **Contains**: Data reading/writing, student lookup, batch updates
- **Benefits**: Reduced API calls, intelligent caching, better performance

### 5. **grading-service.ts** - AI-Powered Grading
- **Purpose**: OpenAI integration and intelligent analysis
- **Contains**: ChatGPT analysis, diff processing, review generation
- **Benefits**: Content optimization, token management, fallback strategies

### 6. **utils.ts** - Utility Functions
- **Purpose**: Common helper functions and utilities
- **Contains**: String processing, performance monitoring, validation
- **Benefits**: Code reuse, consistent logging, debugging tools

### 7. **main-refactored.ts** - Orchestration Layer
- **Purpose**: Main workflow coordination and UI
- **Contains**: Sync orchestration, menu creation, setup functions, testing
- **Benefits**: Clean separation of concerns, easier maintenance

## ‚ö° Performance Improvements

### Caching Strategy
- **Sheet Data**: 5-minute cache for spreadsheet data
- **API Responses**: 10-minute cache for GitHub API calls
- **Student Lookup**: In-memory map for O(1) student lookups

### Batch Operations
- **Sheet Updates**: Batch multiple cell updates into fewer API calls
- **PR Processing**: Intelligent filtering to avoid reprocessing
- **Time Limits**: Respects Google Apps Script execution limits

### Resource Optimization
- **Content Limiting**: Intelligent truncation of large diffs for AI analysis
- **Early Termination**: Stops processing when limits are reached
- **Smart Filtering**: Processes only unprocessed PRs

## üéØ Benefits of Modular Architecture

### Development Benefits
- **Easier Debugging**: Isolated components for focused testing
- **Better Testing**: Each module can be unit tested independently
- **Team Collaboration**: Multiple developers can work on different modules
- **Code Reuse**: Services can be used in other Apps Script projects

### Maintenance Benefits
- **Focused Changes**: Modifications only affect relevant modules
- **Clear Dependencies**: Import statements show relationships
- **Consistent Patterns**: Standardized error handling and logging
- **Documentation**: Each module has clear responsibility

### Performance Benefits
- **Reduced Memory Usage**: Only load needed functionality
- **Better Caching**: Module-specific caching strategies
- **Optimized API Calls**: Centralized request management
- **Resource Management**: Better handling of execution limits

## üß™ Testing Strategy

### Module Testing
```javascript
// Test individual services
function testGitHubApi() {
  const prs = GitHubApiService.getRecentPullRequests();
  console.log(`Found ${prs.length} PRs`);
}

function testSheetsService() {
  const student = SheetsService.lookupStudentName('testuser');
  console.log(`Student lookup: ${student}`);
}
```

### Integration Testing
```javascript
// Test full workflow with single PR
function testSinglePR(prNumber: number) {
  const pr = GitHubApiService.getPullRequest(prNumber);
  const result = processPullRequest(pr);
  console.log(result);
}
```

## üìà Monitoring and Debugging

### Performance Monitoring
- **Execution Timing**: Each major operation is timed
- **Cache Hit Rates**: Monitor cache effectiveness  
- **Error Tracking**: Centralized error logging with context

### Debug Tools
- **Cache Clearing**: Manual cache invalidation
- **Test Functions**: Individual component testing
- **Verbose Logging**: Detailed execution traces in development mode

## üîß Configuration

### Environment Setup
```javascript
// Set development mode
PropertiesService.getScriptProperties().setProperty("DEV_MODE", "true");

// Configure API keys
setupGitHubToken();  // Interactive setup
setupOpenAIKey();    // Interactive setup
```

### Custom Configuration
Modify `config.ts` for environment-specific settings:
- Sheet names and column mappings
- Processing limits and timeouts
- Cache durations
- API endpoints

## üöÄ Next Steps

1. **Add Unit Tests**: Create comprehensive test suite for each module
2. **Performance Tuning**: Monitor and optimize based on actual usage
3. **Feature Extensions**: Add new capabilities using the modular structure
4. **Documentation**: Expand documentation as the system grows

This modular architecture provides a solid foundation for scaling the GitHub Grader system while maintaining performance and reliability.